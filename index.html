<!DOCTYPE html>
<html lang=en-AU>
<head>
<meta charset=UTF-8>
<!--script src="./d3/d3.js"></script-->
<script src = "https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
<font size="5"> Where did my vote go in the 2016 federal election?</font><br>

<button type="button" onclick="state = 'NSW'; DisplayBallot()">NSW</button>
<button type="button" onclick="state = 'VIC'; DisplayBallot()">Vic</button>
<button type="button" onclick="state = 'QLD'; DisplayBallot()">QLD</button>
<button type="button" onclick="state = 'WA'; DisplayBallot()">WA</button>
<button type="button" onclick="state = 'SA'; DisplayBallot()">SA</button>
<button type="button" onclick="state = 'TAS'; DisplayBallot()">Tas</button>
<button type="button" onclick="state = 'ACT'; DisplayBallot()">ACT</button>
<button type="button" onclick="state = 'NT'; DisplayBallot()">NT</button>
&nbsp &nbsp &nbsp &nbsp
<button type="button" onclick="FlowPreferences()">VOTE!</button>

<style type="text/css">input[type="number"] {width:40px;}</style>


<p id="demo"> <br></p>

<form id="BALLOT">
<p id="question"> The way that preferences flow in the Australian senate is confusing. This tool shows you where your vote would have flowed in the 2016 senate election.
<br>
<br> <b> THIS TOOL SHOULD NOT BE USED TO PREDICT WHERE PREFERENCES WILL FLOW IN THE 2019 FEDERAL ELECTION! </b>
<br>
<br> Where a vote flows depends on all the other votes cast in the election, so it is imposible to tell exactly where your vote will end up before the 2019 votes are counted.
<br> The best way to ensure your vote goes where you want it to is to make sure you indicate those preferences on your ballot, either above or below the line. By leaving boxes empty, you are effectively ranking the unnumbered parties equal last.
<br>
<br> Furthermore, the 2016 Federal election was a double dissolution election, which means 12 candidates were elected in each state, and 2 in each territory.
<br> The 2019 federal election will (probably) be a normal half senate election, which means only 6 candidates will be elected in each state, and 1 in each territory.
<br>
<br> Select a state, enter your preferences, and then press the VOTE! button to see where that vote would have gone if it was cast in the 2016 Federal election.
<!-- I am from Queensland, where our state parliament is unicameral (we don't have a state senate). If this site is popular, I might consider adapting it to state senates also. -->
</p>
</form>

<script>

function sortNumber(a,b) {
  return a - b;
}

/*####################
### Ballot Display ###
####################*/
function DisplayBallot() {
document.getElementById("question").innerHTML = "";
document.getElementById("demo").innerHTML = "<br>";
d3.csv("./data/" + state + ".csv", function(data) {
var NoCands = data.length;
var ticket = new Array();
var position = new Array();
var surname = new Array();
var forename = new Array();
var party = new Array();

var atlticket  = "<tr>";
var atlbox = "<tr>"
var atlparty = "<tr>"
var btlticket = "<tr>"
var btlparty = "<tr>"

var btltable = new Array();
var defaultmaxposition = 12;
for (var i = 0; i < defaultmaxposition; i++) {
  btltable[i] = new Array();
  for (var j = 0; j < NoCands; j++) {
    btltable[i][j] = "<td></td>";
  }
}

var realmaxposition = 0;
var groupj = -1;
for (var i = 0; i < NoCands; i++) {
  ticket = data[i]["ticket"];
  position = Number(data[i]["ballot_position"]);
  surname = data[i]["surname"];
  forename = data[i]["ballot_given_nm"];
  party = data[i]["party_ballot_nm"];

  if (position > realmaxposition) {
    realmaxposition = Number(position);
  }
  if (position == 1) {
    groupj += 1;
  }

  if (ticket != "UG" && ticket != "UG1"){
    btltable[position-1][groupj] = "<td style=\"border-right: thin solid\">";
    if (position == 1) {
      atlticket += "<td style=\"border-right: thin solid; padding:0px 0px 0px 10px \">" + ticket + "</td>";
      btlticket += "<td style=\"border-right: thin solid; padding:0px 0px 0px 10px \">" + ticket + "</td>";
      atlbox += "<td style=\"border-right: thin solid; padding:0px 0px 0px 5px\"> <input name=\"atl" + ticket + "\" type=\"number\" min=\"1\" max=\"" + NoCands + "\" step=\"1\"> </td>";
      atlparty += "<td style=\"border-right: thin solid; border-bottom: solid; width:2000px; padding:0px 0px 0px 10px\" > <b><font size=\"3\"> <div> " + party + "</div> </td>";
      btlparty += "<td style=\"border-right: thin solid; width:2000px; padding:0px 0px 0px 10px\" > <b><font size=\"3\"> <div> " + party + "</div> </td>";
      }
  } else {
    btltable[position - 1][groupj] = "<td>";
    if (position == 1) {
      atlticket += "<td></td>";
      btlticket += "<td style=\"padding:0px 0px 0px 10px\"> UG </td>";
      atlbox += "<td></td>";
      atlparty += "<td style=\"border-bottom: solid; width:2000px\" > </td>";
      btlparty += "<td style=\"width:2000px; padding:0px 0px 0px 10px\" > <b><font size=\"3\"> <div> Ungrouped </div> </td>";
    }
  }
  btltable[position - 1][groupj] += " <table><tr><td rowspan=\"3\"> <input name=\"btl" + position + ticket + "\" type=\"number\" min=\"1\" max=\"" + NoCands + "\" step=\"1\"> </td>\
  <td> <b><font size=\"2\">" + surname + "</b></td></tr> <tr><td> " + forename + "</td></tr> <tr><td> " + party + "</font></td></tr></table></td>";
}

var tablestring = "<table style='width:2000px' table-layout:\"fixed\">" + atlticket + "</tr>" + atlbox + "</tr>" + atlparty + "</tr>" + "</tr>" + btlticket + "</tr>" + btlparty + "</tr>";
for (var i = 0; i < realmaxposition; i++) {
  tablestring += "<tr>";
  for (var j = 0; j < NoCands; j++) {
    tablestring += btltable[i][j];
  }
  tablestring += "</tr>";
}
document.getElementById("question").innerHTML+=  tablestring + "</table>";
});
}


function FlowPreferences() {
console.log("***");
document.getElementById("demo").innerHTML="";

d3.csv("./data/" + state + ".csv", function(data) {

/*###################
### Read csv data ###
###################*/

var NoCands = data.length;
var ticket = new Array();
var position = new Array();
var surname = new Array();
var forename = new Array();
var party = new Array();
var resultorder = new Array();
var fate = new Array();
var transfervalue = new Array();
for (var i = 0; i < NoCands; i++) {
  ticket[i] = data[i]["ticket"];
  position[i] = Number(data[i]["ballot_position"]);
  surname[i] = data[i]["surname"];
  forename[i] = data[i]["ballot_given_nm"];
  party[i] = data[i]["party_ballot_nm"];
  resultorder[i] = Number(data[i]["elimination_order"]);
  fate[i] = data[i]["fate"];
  transfervalue[i] = Number(data[i]["transfer_factor"]);
}


/*######################
### Input Validation ###
######################*/

var RepeatError = false;
var BothLineError = false;
var TooManyError = false;
var NotEnoughError = false;
var MissingError = false;

var ErrorMessage = "Warning! This vote is not valid! <br>"
var atlj = 0;
var btlj = 0;
var j = 0;
var atlVote = new Array();
var atlOnly = new Array();
var sudoVote = new Array();
var btlVote = new Array();
var btlOnly = new Array();
var atobtlVote = new Array();

//read input (repetition check)
var x = document.getElementById("BALLOT");
for (var i = 0; i < NoCands; i++) {
  var btly = Number(x.elements["btl"+position[i]+ticket[i]].value);
  btlVote[i] = btly;
  if (btly > 0) {
      if (btlOnly.includes(btly)) {
        RepeatError = true;
        document.getElementById("demo").innerHTML+= ErrorMessage + "You have given multiple candidates preference " + btly +" below the line. <br>";}
      btlOnly[btlj] = btly;
      btlj += 1;
    }

  if (position[i] == 1 && ticket[i] != "UG" && ticket[i] != "UG1") {
    var atly = Number(x.elements["atl"+ticket[i]].value);
    atlVote[j] = atly;
    if (atly > 0) {
      if (atlOnly.includes(atly)) {
        RepeatError = true;
        document.getElementById("demo").innerHTML+= ErrorMessage + "You have given multiple parties preference " + atly +" above the line. <br>";}
      atlOnly[atlj] = atly;
      atlj += 1;
    }
  j += 1;
  }

  atobtlVote[i] = 0;
  if (atly > 0) {
    sudoVote[i] = (atly - 1) * 12 + position[i];
  } else {
    sudoVote[i] = 0;
  }
}

var atlMaxPref = Math.max.apply(null, atlOnly);
var btlMaxPref = Math.max.apply(null, btlOnly);
var atlNoPrefs = atlOnly.length;
var btlNoPrefs = btlOnly.length;

// LineError, toomanyError, MissingError, nodataerror
if (atlNoPrefs > 0 && btlNoPrefs > 0) {
  BothLineError = true;
  document.getElementById("demo").innerHTML+= ErrorMessage + "You have indicated preferences both above and below the line. <br>";

} else if (atlNoPrefs > 0) {
  if (atlMaxPref > atlVote.length) {
    TooManyError = true;
    document.getElementById("demo").innerHTML+= ErrorMessage + "Your highest above the line preference, " + atlMaxPref +", is higher than the number of grouped parties, which is only " + atlVote.length + ". <br>";
  } else if (atlMaxPref < 6) {
    NotEnoughError = true;
    document.getElementById("demo").innerHTML+= ErrorMessage + "You have not indicated enough preferences. You need to give at least 6 above the line preferences, but the highest preference you have given is " + atlMaxPref + ". <br>";
  } else {
    for (var j = 1; j <= atlNoPrefs; j++) {
      if (!(atlOnly.includes(j)) && !MissingError && !TooManyError && !RepeatError && !BothLineError && !NotEnoughError) {
        MissingError = true;
        document.getElementById("demo").innerHTML+= ErrorMessage + "You have indicated an above the line preference up to " + atlMaxPref + ", but you have missed lower preferences, such as " + j + ". <br>"
      }
    }
  }

  // Transcribe atl to btl
  var sudosort = sudoVote.concat().sort(sortNumber);
  for (var j = 0; j < NoCands; j++) {
    if (sudosort[j] != 0){
      atobtlVote[sudoVote.indexOf(sudosort[j])] = 1 + j - sudosort.indexOf(1);
    }
  }
  var MaxPref = Math.max.apply(null, atobtlVote);
  var Vote = atobtlVote;

} else if (btlNoPrefs > 0) {
  if (btlMaxPref > NoCands) {
    TooManyError = true;
    document.getElementById("demo").innerHTML+= ErrorMessage + "Your highest below the line preference " + btlMaxPref +" is higher than the number of candidates, which is only " + NoCands + ". <br>";
  } else if (btlMaxPref < 12) {
    NotEnoughError = true;
    document.getElementById("demo").innerHTML+= ErrorMessage + "You have not indicated enough preferences. You need to give at least 12 below the line preferences, but the highest preference you have given is " + btlMaxPref + ". <br>";
  } else {
    for (var j = 1; j <= btlNoPrefs; j++) {
      if (!(btlOnly.includes(j)) && !MissingError && !TooManyError && !RepeatError && !BothLineError && !NotEnoughError) {
        MissingError = true;
        document.getElementById("demo").innerHTML+= ErrorMessage + "You have indicated a below the line preference up to " + btlMaxPref + ", but you have missed lower preferences, such as " + j + ". <br>"
      }
    }
  }

  var MaxPref = btlMaxPref;
  var Vote = btlVote;

} else {
  BothLineError = true;
  document.getElementById("demo").innerHTML+= ErrorMessage + "You have not indicated any preferences!"
}

/*############
### OUTPUT ###
############*/

if (!RepeatError && !MissingError && !TooManyError && !BothLineError && !NotEnoughError){

var votelive = true;	// Becomes false when vote Exhausts or doesn't elect anyone
var voteorder = -1;	// The relative distribution round of the current preference
var votevalue = 100;	// The initial vote value
var electedvalue = 100 - votevalue;	// This will
var prefind = 1; 	// This keeps track of the number of the current preference

while (votelive && prefind <= MaxPref) {
  var candind = Vote.indexOf(prefind);	// index of next candidate preferenced
  var candorder = resultorder[candind];
  //console.log("preference index: ", prefind, candind, " candidate order ", candorder, fate[candind], voteorder)

  if (candorder > voteorder) {
    if (voteorder == -1) {
      document.getElementById("demo").innerHTML+="Your first preference was ";
    } else {
      document.getElementById("demo").innerHTML+="Your next preference that hasn't been elected or excluded was ";
    }
    var voteorder = candorder;

    if (fate[candind] == "Elected") {
      electedvalue = Math.round(100 * votevalue * (1 - transfervalue[candind])) / 100;
      votevalue = Math.round(100 * votevalue * transfervalue[candind]) / 100;
      document.getElementById("demo").innerHTML+= forename[candind] + " " + surname[candind] + " of the <b>" + party[candind] + "</b>. They were elected! <br><br> This candidate was elected with more than the number of votes that they needed to win a seat, so their extra votes transferred to their next preference. However, it would be unfair to randomly choose which of these excess votes are transferred, and which stay with this candidate. So ALL the votes are transferred, but as they have already elected a candidate, they are no longer worth one vote, but are reduced in value, so that the total value of the transferred votes is equal to the number of excess votes this candidate received. Hence, " + electedvalue + "% of your vote elected " + party[candind] + " and " + votevalue + "% flowed to your next preference. <br><br>";

    } else if (fate[candind] == "Final") {
      document.getElementById("demo").innerHTML+= forename[candind] + " " + surname[candind] + " of the <b>" + party[candind] + "</b>. They were elected! <br><br> This was the final candidate elected so no more preferences were transfered. <br>";
      votelive = false;

    } else if (fate[candind] == "Bag") {
      document.getElementById("demo").innerHTML+= forename[candind] + " " + surname[candind] + " of the <b>" + party[candind] + "</b>. All the senate seats were filled before this candidate was excluded, so your vote extinguished here. <br>";
      votelive = false;

    } else if (fate[candind] == "Transfer") {
      document.getElementById("demo").innerHTML+= forename[candind] + " " + surname[candind] + " of the <b>" + party[candind] + "</b>. They were not elected, but there are still vacant senate seats, so your vote will be transfered to your next prefence. <br>";

    } else {
      document.getElementById("demo").innerHTML+= "Error! Candind: " + candind + "<br>";
      console.log(fate[candind])
    }
  }

  prefind += 1;
}
//console.log("preference index: ", prefind, candind, " candidate order ", candorder, fate[candind])
if (votelive) {
  document.getElementById("demo").innerHTML+= "However, the rest of your preferences have either been elected or excluded, so your vote was exhausted. <br>";
}

}
});
}

</script>

<div id=copyright> <!--<aMitchell Gooding</a>.-->
Commonweath electoral data is copyright © Australian Electoral Commission (AEC) and licensed under a Creative Commons Attribution 4.0 International Licence (CC BY 4.0). <!--and reproduced with permission.-->
</div>
</body>
</html>
